var conduitApp={},coduitTemplates={},conduitRegisterApps,conduitModal,conduitModalSave,conduitGenID,conduitGetData;!jQuery(function(a){var b=null;conduitException=function(a){this.message=a,this.name="ConduitException"},a.fn.conduitTrigger=function(b){var c={method:"GET",url:ajaxurl};return a.extend(!0,c,b),a.ajax(c).success(function(){}),this},a.fn.getObject=function(b){for(var c=a(this),d=c.find("[name]"),e={},f={},g=0;g<d.length;g++){var h=a(d[g]),i=h.prop("name").replace(/\]/gi,"").split("["),j=h.val(),k={};if((!b||!(i.indexOf("_id")>=0||i.indexOf("_node_point")>=0))&&(!h.is(":radio")&&!h.is(":checkbox")||h.is(":checked"))){if(h.prop("required")&&!h.val().length)throw h.focus(),new conduitException("requiredfield");for(var l=i.length-1;l>=0;l--){var m=i[l];if("undefined"==typeof m&&(m=""),0===m.length&&(k=[],"undefined"==typeof f[i[l-1]]?f[i[l-1]]=0:f[i[l-1]]+=1,m=f[i[l-1]]),l===i.length-1){if(j)if("true"===j)j=!0;else if("false"===j)j=!1;else if(isNaN(parseFloat(j))||parseFloat(j).toString()!==j){if("string"==typeof j&&("{"===j.substr(0,1)||"["===j.substr(0,1)))try{j=JSON.parse(j)}catch(n){}}else j=parseFloat(j);k[m]=j}else{var o=k;k={},k[m]=o}}a.extend(!0,e,k)}}return e},conduitPrepObject=function(){var a={};for(var b in conduitApp)conduitApp[b].app&&(conduitApp[b].app.is(":visible")?a[b]=conduitBuildData(b):a[b]=conduitApp[b].data),a[b]._tab&&delete a[b]._tab;return a},conduitGetData=function(a){var b=a.trigger.data("app"),c={};return conduitApp[b]&&conduitApp[b].data?conduitApp[b].data:c},conduitBuildData=function(a){if(conduitApp[a]&&conduitApp[a].app)try{conduitApp[a].data=conduitApp[a].app.getObject()}catch(b){return!1}return conduitApp[a].data._tab&&delete conduitApp[a].data._tab,conduitApp[a].input.val(JSON.stringify(conduitApp[a].data)),conduitApp[a].data},conduitSyncData=function(a){conduitBuildData(a)},conduitRegisterApps=function(){var b=a("[data-app]").not("._bound_app");b.length&&b.each(function(){var b=a(this),c=b.data("app"),d=a('[name="'+c+'"]'),e=d.data("data");conduitApp[c]={app:b,data:e,input:d},b.addClass("_bound_app"),conduitBuildUI(c)})},conduitBuildUI=function(b){if(conduitApp[b]){var c=conduitApp[b].data;conduitApp[b].app.html(coduitTemplates[b](c))}a(".fwpmanip-sortable").length&&a(".fwpmanip-sortable").each(function(){var b=a(this),c={forcePlaceholderSize:!0,placeholder:"fwpmanip-sortable-placeholder"};c=a.extend({},c,b.data()),a(this).sortable(c)}),a(document).trigger("fwpmanip.init"),a(window).trigger("modal.init")},conduitSetNode=function(b,c,d){for(var e=b.split("."),f='{ "'+e.join('": { "')+'" : '+JSON.stringify(d),g=0;g<e.length;g++)f+="}";var h=JSON.parse(f);a.extend(!0,conduitApp[c].data,h),conduitBuildUI(c)},conduitGenID=function(){var a=(new Date).getTime(),b="ndxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:3&c|8).toString(16)});return b},conduitAddNode=function(b,c,d){var e=conduitGenID(),f=b.data?b.data("addNode").split("."):b.split("."),g=d?d:b.data("nodeDefault"),h=f.join(".")+"."+e,i=JSON.parse('{ "_id" : "'+e+'", "_node_point" : "'+h+'" }');node_point_wrappers=a('[data-node-point="'+f.join(".")+'"]'),g&&"object"==typeof g&&a.extend(!0,i,g);for(var j='{ "'+f.join('": { "')+'" : { "'+e+'" : '+JSON.stringify(i),k=0;k<=f.length;k++)j+="}";var l=JSON.parse(j);conduitBuildData(c),a.extend(!0,conduitApp[c].data,l),node_point_wrappers.length&&node_point_wrappers.data("template")?node_point_wrappers.each(function(){var b=a(this),c=b.data("template");c&&coduitTemplates["__partial_"+c]&&b.append(coduitTemplates["__partial_"+c](i))}):conduitBuildUI(c),conduitBuildData(c)},a(document).on("keyup change",'[data-format="slug"]',function(b){var c=a(this);return c.data("master")&&c.prop("required")&&this.value.length<=0&&"change"===b.type?(this.value=a(c.data("master")).val().replace(/[^a-z0-9]/gi,"_").toLowerCase(),void(this.value.length&&c.trigger("change"))):void(this.value=this.value.replace(/[^a-z0-9]/gi,"_").toLowerCase())}),a(document).on("keyup change","[data-sync]",function(){var b=a(this),c=a(b.data("sync"));c.each(function(){var c=a(this);c.is("input")?c.val(b.val()).trigger("change"):c.text(b.val())})}),a(document).on("click","[data-add-node]",function(b){var c=a(this),d=c.closest("[data-app]").data("app");d&&"object"==typeof conduitApp[d]&&(b.preventDefault(),conduitAddNode(c,d))}),a(document).on("click","[data-remove-element]",function(b){var c=a(this),d=c.closest("[data-app]").data("app"),e=a(c.data("removeElement"));(!c.data("confirm")||confirm(c.data("confirm")))&&(e.remove(),conduitSyncData(d))}),a(document).on("change","[data-live-sync]",function(b){var c=a(this).closest("[data-app]").data("app");conduitSyncData(c),conduitBuildUI(c)}),a(document).on("click","button[data-live-sync]",function(b){var c=a(this).closest("[data-app]").data("app");conduitSyncData(c)}),a(document).on("click",".fwpmanip-notice .notice-dismiss",function(){var b=a(this).closest(".fwpmanip-notice");b.slideUp(200,function(){b.remove()})}),a("script[data-template]").each(function(){var b=a(this),c=b.data("template");coduitTemplates[c]=Handlebars.compile(b.html(),{data:!0})}),a("script[data-handlebars-partial]").each(function(){var b=a(this);Handlebars.registerPartial(b.data("handlebarsPartial"),b.html()),coduitTemplates["__partial_"+b.data("handlebarsPartial")]=Handlebars.compile(b.html(),{data:!0})}),a(document).on("click","[data-modal-node]",function(b){var c,d=a(this),e=d.data("modal-node").split("."),f=d.data("app")?d.data("app"):e.shift(),g=d.data("type")?d.data("type"):"save";if(d.data("before")&&("function"==typeof d.data("before")?d.data("before")(d):"function"==typeof window[d.data("before")]&&window[d.data("before")](d)),"delete"!==g)try{c=d.closest(".fwpmanip-modal-wrap").getObject()}catch(b){return}if("add"===g)conduitAddNode(e.join("."),f,c);else if("delete"===g){var h=e.shift();e.length&&(h+="["+e.join("][")+"]"),a('[name^="'+h+'"]').remove(),conduitBuildData(f),conduitBuildUI(f)}else conduitSetNode(e.join("."),f,c);a(window).trigger("close.modal"),d.data("callback")&&("function"==typeof d.data("callback")?d.data("callback")(c,d):"function"==typeof window[d.data("callback")]&&window[d.data("callback")](c,d))}),a(window).on("close.modal",function(b){var c=a(".active[data-tab]").data("tab");c&&conduitBuildUI(c)}),a(document).on("fwpmanip.itemsubmit",function(){conduitPrepObject()}),a(document).on("fwpmanip.init",function(){conduitRegisterApps()}),window.onbeforeunload=function(){return b?!1:void 0}});